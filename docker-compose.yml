# Skill Development & Training Management System â€” Docker Compose
# Run from project root: docker compose up -d
# Frontend: http://localhost:9090  |  Gateway: http://localhost:8080  |  Eureka: http://localhost:8761
#
# Database: MySQL only. Every service that uses a database has SPRING_PROFILES_ACTIVE=mysql
# so H2 is never used in Docker; all connect to the mysql container via env-based config.

services:
  mysql:
    image: mysql:8.0
    container_name: skilldev-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: trainer_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - skilldev-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot"]
      interval: 5s
      timeout: 5s
      retries: 10

  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    container_name: skilldev-eureka
    ports:
      - "8761:8761"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
    networks:
      - skilldev-net
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8761/", "||", "exit", "1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 25s

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: skilldev-gateway
    ports:
      - "8080:8080"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      APP_SECURITY_SERVICE_URL: http://security-service:8081
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - skilldev-net

  security-service:
    build:
      context: ./security-service
      dockerfile: Dockerfile
    container_name: skilldev-security
    ports:
      - "8081:8081"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - skilldev-net

  validation-service:
    build:
      context: ./validation-service
      dockerfile: Dockerfile
    container_name: skilldev-validation
    ports:
      - "8082:8082"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - skilldev-net

  trainer-service:
    build:
      context: ./trainer-service
      dockerfile: Dockerfile
    container_name: skilldev-trainer
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: mysql
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/trainer_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      mysql: { condition: service_healthy }
      eureka-server: { condition: service_healthy }
    networks:
      - skilldev-net

  course-service:
    build:
      context: ./course-service
      dockerfile: Dockerfile
    container_name: skilldev-course
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: mysql
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/course_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      mysql: { condition: service_healthy }
      eureka-server: { condition: service_healthy }
    networks:
      - skilldev-net

  trainee-service:
    build:
      context: ./trainee-service
      dockerfile: Dockerfile
    container_name: skilldev-trainee
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: mysql
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/trainee_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      mysql: { condition: service_healthy }
      eureka-server: { condition: service_healthy }
    networks:
      - skilldev-net

  assessment-service:
    build:
      context: ./assessment-service
      dockerfile: Dockerfile
    container_name: skilldev-assessment
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: mysql
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/assessment_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      mysql: { condition: service_healthy }
      eureka-server: { condition: service_healthy }
    networks:
      - skilldev-net

  certification-service:
    build:
      context: ./certification-service
      dockerfile: Dockerfile
    container_name: skilldev-certification
    ports:
      - "8087:8087"
    environment:
      SPRING_PROFILES_ACTIVE: mysql
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFERIPADDRESS: "true"
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/certification_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      mysql: { condition: service_healthy }
      eureka-server: { condition: service_healthy }
    networks:
      - skilldev-net

  frontend-app:
    build:
      context: ./frontend-app
      dockerfile: Dockerfile
    container_name: skilldev-frontend
    ports:
      - "9090:9090"
    environment:
      APP_GATEWAY_URL: http://api-gateway:8080
    depends_on:
      - api-gateway
    networks:
      - skilldev-net

networks:
  skilldev-net:
    driver: bridge

volumes:
  mysql_data:
